
def product_history(request, product_id):

    product = Product.objects.get(product_id=product_id)
    
    product_batches = ProductBatch.objects.filter(product=product).select_related('product', 'supplier').order_by('-stock_date')
    
    for batch in product_batches:
        activities = []
        for order in Order.objects.filter(batch_sku=batch.batch_sku).select_related('customer'):
            activities.append({
                'date': order.order_date,
                'activity_type': 'Order',
                'quantity': -order.quantity, 
                'reference': f"Order #{order.id}",
                'user': order.customer or {'username': 'System'}
            })
        # Adjustments
        for adj in StockAdjustment.objects.filter(batch=batch).select_related('user'):
            activities.append({
                'date': adj.created_at,
                'activity_type': adj.get_adjustment_type_display(),
                'quantity': adj.quantity if adj.adjustment_type == 'add' else -adj.quantity,
                'reference': adj.reason,
                'user': adj.user or {'username': 'System'}
            })
        # Batch receipt
        activities.append({
            'date': batch.stock_date,
            'activity_type': 'Received',
            'quantity': batch.initial_quantity,
            'reference': 'Batch Receipt',
            'user': {'username': 'System'}
        })
        activities.sort(key=lambda x: x['date'], reverse=True)
        batch.activities = activities
    
    # Combined activity
    combined_activity = []
    for batch in product_batches:
        combined_activity.append({
            'date': batch.stock_date,
            'event_type': 'batch',
            'description': f"Batch {batch.batch_sku} added with {batch.initial_quantity} {product.units}",
            'quantity': batch.initial_quantity,
            'customer': {'name': 'System'}
        })
    
    orders = Order.objects.filter(product=product).select_related('batch', 'customer').order_by('-order_date')
    for order in orders:
        combined_activity.append({
            'date': order.order_date,
            'event_type': 'order',
            'description': f"Order #{order.id} placed for {order.quantity} {product.units}" + (f" from batch {order.batch.batch_sku}" if order.batch else ""),
            'quantity': order.quantity,
            'customer': order.customer or {'name': 'System'}
        })
    
    adjustments = StockAdjustment.objects.filter(product=product).select_related('batch', 'user').order_by('-created_at')
    for adj in adjustments:
        combined_activity.append({
            'date': adj.created_at.date(),
            'event_type': 'adjustment',
            'description': f"Stock {adj.adjustment_type} of {adj.quantity} {product.units} ({adj.reason})" + (f" for batch {adj.batch.batch_sku}" if adj.batch else ""),
            'quantity': adj.quantity if adj.adjustment_type == 'add' else -adj.quantity,
            'customer': adj.user or {'name': 'System'}
        })
    
    # Sort by date descending
    combined_activity.sort(key=lambda x: x['date'], reverse=True)
    
    # Paginate combined activity
    activity_paginator = Paginator(combined_activity, 10)
    activity_page = request.GET.get('page', 1)
    combined_activity = activity_paginator.get_page(activity_page)
    
    # Paginate orders
    orders_paginator = Paginator(orders, 10)
    orders_page = request.GET.get('page', 1)
    orders = orders_paginator.get_page(orders_page)
    
    # Paginate adjustments
    adjustments_paginator = Paginator(adjustments, 10)
    adjustments_page = request.GET.get('page', 1)
    adjustments = adjustments_paginator.get_page(adjustments_page)
    
    # Sales data for last 12 months
    today = datetime.now().date()
    sales_labels = []
    sales_data = []
    for i in range(11, -1, -1):
        month_start = (today - relativedelta(months=i)).replace(day=1)
        month_end = (month_start + relativedelta(months=1)) - timedelta(days=1)
        sales_labels.append(month_start.strftime("%b %Y"))
        monthly_sales = Order.objects.filter(
            product=product,
            order_date__gte=month_start,
            order_date__lte=month_end
        ).aggregate(total=Sum('quantity'))['total'] or 0
        sales_data.append(monthly_sales)
    
    # Batch data for charts
    batch_labels = [f"Batch {batch.batch_sku}" for batch in product_batches]
    batch_quantities = [batch.current_quantity for batch in product_batches]
    
    # Product metrics
    thirty_days_ago = today - timedelta(days=30)
    total_sold_last_30_days = Order.objects.filter(
        product=product, order_date__gte=thirty_days_ago
    ).aggregate(total=Sum('quantity'))['total'] or 0
    
    yearly_sales = Order.objects.filter(
        product=product, order_date__gte=today - timedelta(days=365)
    ).aggregate(total=Sum('quantity'))['total'] or 0
    avg_monthly_sales = yearly_sales / 12 if yearly_sales else 0
    
    suggested_reorder_quantity = product.reorder_level * 2 if product.reorder_level else 0
    
    expiring_batches_count = product_batches.filter(
        expiry_date__lte=today + timedelta(days=30),
        expiry_date__gte=today
    ).count()
    
    context = {
        'product': product,
        'product_batches': product_batches,  # Added for Batch History tab
        'combined_activity': combined_activity,
        'orders': orders,
        'adjustments': adjustments,
        'total_sold_last_30_days': total_sold_last_30_days,
        'avg_monthly_sales': avg_monthly_sales,
        'suggested_reorder_quantity': suggested_reorder_quantity,
        'expiring_batches_count': expiring_batches_count,
        'sales_labels': sales_labels,
        'sales_data': sales_data,
        'batch_labels': batch_labels,
        'batch_quantities': batch_quantities,
        'active_tab': request.GET.get('tab', 'activity'),
    }
    
    return render(request, 'InvApp/product_history.html', context)



    
def product_history(request, product_id):
product = get_object_or_404(Product, pk=product_id)

combined_activity = []

for batch in product.productbatch_set.all():

    combined_activity.append({
        'date': batch.stock_date,
        'event_type': 'batch',
        'description': f"Batch {batch.batch_sku} added with {batch.initial_quantity} {product.units}",
        'quantity': batch.initial_quantity
    })

    orders = product.order_set.all().order_by('-order_date')

for order in orders:
    combined_activity.append({
        'date': order.order_date,
        'event_type': 'order',
        'user': order.customer,
        'quantity': order.quantity
    })

adjustments = product.stockadjustment_set.all().order_by('-created_at')

for adj in adjustments:
    combined_activity.append({
        'date': adj.created_at.date(),
        'event_type': 'adjustment',
        'description': f"Stock adjustment: {adj.quantity} {product.units} ({adj.reason})",
        'quantity': adj.quantity
    })

 # Sort by date descending
combined_activity.sort(key=lambda x: x['date'], reverse=True)

paginator = Paginator(combined_activity, 10)
page_number = request.GET.get('page')
page_obj = paginator.get_page(page_number)

today = datetime.now()
sales_labels = []
sales_data = []

for i in range(11, -1, -1):
 month = today - relativedelta(months=i)
 sales_labels.append(month.strftime("%b %Y"))
 sales_data.append(0) 

batch_labels = [f"Batch {batch.batch_sku}" for batch in product.productbatch_set.all()]
batch_quantities = [batch.current_quantity for batch in product.productbatch_set.all()]

context = {
    'product': product,
    'combined_activity': page_obj,
    'orders': orders,
    'adjustments': adjustments,
    'sales_labels': sales_labels,
    'sales_data': sales_data,
    'batch_labels': batch_labels,
    'batch_quantities' : batch_quantities,
}

return render(request, 'InvApp/product_history.html', context)
