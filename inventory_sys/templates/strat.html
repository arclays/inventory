
def place_order(request):
    if request.method == 'POST':
        try:
            customer_id = request.POST.get('orderCustomer')
            order_date = request.POST.get('orderDate')
            payment_method = request.POST.get('paymentMethod')
            products = request.POST.getlist('products[]')
            quantities = request.POST.getlist('orderQuantity[]')
            units = request.POST.getlist('units[]')
            price_per_units = request.POST.getlist('price_per_unit[]')
            discounts = request.POST.getlist('productDiscount[]')
            batch_skus = request.POST.getlist('batch_sku[]')

            customer = Customer.objects.get(id=customer_id)
            order_date = datetime.strptime(order_date, '%Y-%m-%d').date()

            for i in range(len(products)):
                product = Product.objects.get(product_id=products[i])
                quantity = int(quantities[i])
                discount = float(discounts[i]) if discounts[i] else 0.0
                price_per_unit = float(price_per_units[i])
                total_price = quantity * price_per_unit
                final_total = total_price * (1 - discount / 100)

                # Update inventory
                if product.quantity_in_stock < quantity:
                    messages.error(request, f"Insufficient stock for {product.name}")
                    return redirect('order_page')
                product.quantity_in_stock -= quantity
                product.save()

                # Handle batch
                batch_sku = None
                if batch_skus[i]:
                    batch_sku = ProductBatch.objects.get(id=batch_skus[i])
                    if batch_sku.initial_quantity < quantity:
                        messages.error(request, f"Insufficient batch quantity for {batch_sku.batch_sku}")
                        return redirect('order_page')
                    batch_sku.initial_quantity -= quantity
                    batch_sku.save()

                # Create order
                Order.objects.create(
                    customer=customer,
                    product=product,
                    batch_sku=batch_sku,
                    quantity=quantity,
                    units=units[i],
                    price_per_unit=price_per_unit,
                    total_price=total_price,
                    payment_method=payment_method,
                    discount=discount,
                    final_total=final_total,
                    order_date=order_date,
                    status='completed'
                )

            messages.success(request, "Order placed successfully!")
            return redirect('order_page')
        except Exception as e:
            logger.error("Error placing order: %s", str(e))
            messages.error(request, f"Error placing order: {str(e)}")
            return redirect('order_page')
    return redirect('order_page')
